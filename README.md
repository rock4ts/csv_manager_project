# CSV-manager project

## **О проекте**

CSV-manager - это HTTP сервис для работы с данными импортируемых csv-файлов.
Он позволяет загружать csv-файлы произвольной структуры, запрашивать метаданные файлов,
включая имена столбцов и количество записей,
а также получать записи конкретного файла с опциональными фильтрацией и сортировкой по одному или нескольким столбцам.


## **Технологии проекта**

* Python 3.9
* Django 4.2.0
* Django Rest Framework 3.14.0
* Pandas 2.1.0
* Simple JWT 2.8.0
* Docker 19.03.0


## **Запуск проекта**

Проект можно запустить двумя способами в локальной среде или в docker-контейнере.

После успешного запуска, сервис будет доступен по адресу [localhost:8000](localhost:8000) или [127.0.0.1:8000](127.0.0.1:8000).

### **Запуск в локальной среде**

Для запуска проекта в среде вашей операционной системы выполните следующие шаги:

1. Создайте папку `csv_manager_project`, перейдите в неё и клонируйте репозиторий.
```
git clone git@github.com:rock4ts/csv_manager_project.git
```

2. Создайте и активируйте виртуальное окружение.
```
python3 -m venv venv
```
```
source venv/bin/activate
```

3. Перейдите в папку `csv_manager`, обновите менеджер пакетов `pip` и установите зависимости.
```
cd csv_manager/
```
```
python -m pip install --upgrade pip
```
```
pip install -r requirements.txt
```

4. Сгенерируйте `SECRET_KEY` в интерактивном режиме django.
```
python manage.py shell
```
```
from django.core.management.utils import get_random_secret_key
```
```
get_random_secret_key()
```

Выйдите из интерактивного режима командой `exit()` и замените в файле `settings.py` значение переменной `SECRET_KEY` на полученное.

5. Создайте суперпользователя для доступа к админ зоне.
```
python manage.py createsuperuser
```

6. Запустите проект.
```
python manage.py runserver
```

### **Запуск в docker-контейнере**

Для запуска проекта в docker-контейнере вам необходимо иметь установленный контейнизатор приложений Docker версии 19.03.0 или выше.

1. Загрузите docker-образ проекта.
```
docker image pull rock4ts/csv-manager:v1
```

2. Создайте и запустите контейнер командой.
```
docker run -d --name csv-manager -it -p 8000:8000 rock4ts/csv-manager:v1
```

3. Создайте суперпользователя для доступа к админ-зоне.
```
docker exec -it csv-manager python manage.py createsuperuser
```


## **Эндпоинты API**

Проект включает два основных вида запросов: запросы связанные с управлением пользователями и работой с csv-файлами.
С полным списком доступных эндпоинтов можно ознакомиться адресу [localhost:8000/redoc].
Ниже даны описания ресурсов регистрации и авторизации пользователя, а также подробно изложены возможности и порядок взаимодействия с api проекта.

### **Регистрация и авторизация**

* **Регистрация**.<br>
```
http://127.0.0.1:8000/auth/users/
```
Чтобы зарегистрировать нового пользователя, отправьте `POST` запрос по указанному адресу, в теле запроса в формате JSON укажите параметры `"username"` и `"password"`.
Ответ успешной регистрации вернёт данные нового пользователя, например:
```
{
    "email": "",
    "username": "rock4ts",
    "id": 1
}
```
<br>

* **Получение токена авторизации.**<br>
```
http://127.0.0.1:8000/auth/jwt/create/
```
Отправьте `POST` запрос к данному эндпоинту, в теле в формате JSON укажите `"username"` и `"password"`:
При выполнении запроса API вернёт токен в поле access, а данные поля refresh пригодятся для обновления токена. Пример ответа с JWT-токеном:
```
{
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTY2MzY2Njg3NCwianRpIjoiNWE0ZjIwMGQxN2RmNDBhMGJkY2JmN2YyYTRjYTE0MTQiLCJ1c2VyX2lkIjoxfQ.SzIFfzaC1wxIuwrH1kE-91Uu0b0yWqrW7Pg38i",
    "access": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNjYzOTI2MDc0LCJqdGkiOiJmMTU3MzAxMGZhNjk0ZmNiOTI1ZTA0NmI3ZGNlNjA4OCIsInVzZXJfaWQiOjF9.IjyppcUSfKzBWlivZo0DZPlZ7JAkpkOMVeBMQPxH"
}
```

### **Работа с csv-файлами**

*Для доступа к работе с файлами в заголовках запроса передавайте полученый токен авторизации!*

* **Загрузка csv-файла**
```
http://127.0.0.1:8000/csv_api/files/
```
Данный эндпоинт принимает **POST**-запрос, в теле которого содержиться адрес csv-файла на вашем компьютере.
Перед отправкой запроса необходимо указать **header Content-Displosition** со значением **attachment** и параметром **filename**. Параметр `filename` будет использован в качестве имени файла созданного в базе данных объекта. Пример заголовка:
`Content-Disposition: attachment; filename=chatgpt_prompts.csv`

Успешный запрос сохранит файл в папке проекта и создаст в базе данных объект, содержащий ссылку на этот файл, имя файла и json объект с его содержанием.
<br>

* **Получение списка загруженных файлов и их метаданных**
```
http://127.0.0.1:8000/csv_api/files/?**query_params
```
Эндпоинт принимает **GET**-запросы и возвращает список сохранённых csv-файлов, а также имена содержащихся в них колонках и количество записей.<br>
Содержание и вид результата запроса можно изменить, указав следующие параметры:<br>
```
ordering='имя столбца(ов) сортировки результата;

search='значение поиска по частичному совпадению id, имени файла или названию колонки';

limit='количество объектов на странице';

offset='числовой указатель начала просмотра результирующего списка относительно первой записи'
```

Формат ответа:
```
{
    "count": 0,
    "next": "http://example.com",
    "previous": "http://example.com",
    "results": [
        {
            "id": 0,
            "filename": "somefile.csv",
            "column_names": ["col1", "col2"],
            "number_of_entries": 100
        },
        {
            "id": 1,
            "filename": "somefile2.csv",
            "column_names": ["col1", "col2"],
            "number_of_entries": 101
        }
    ]
}
```
<br>

* **Получение информации о конкретном файле**
```
http://127.0.0.1:8000/csv_api/files/{file_name}/
```
Информацию о конкретном файле можно получить, указав в адресе запроса имя файла `{file_name}`.<br>
Пример ответа:
```
{
    "id": 0,
    "filename": "somefile.csv",
    "column_names": ["col1", "col2"],
    "number_of_entries": 100
}
```
<br>

* **Удаление csv-файла**
```
http://127.0.0.1:8000/csv_api/files/{file_name}/
```
Запрос с указанием в адресе имени файла `{file_name}` отправленный методом **DELETE** удалит сохранённый файл и объект базы данных.
<br>

* **Маркировка datetime колонок**
```
http://127.0.0.1:8000/csv_api/files/{file_name}/mark_datetime/{datetime_col}/
```
Данный эндпоинт необходим для маркировки **datetime** колонок.<br>
Маркировка необходима при распознавании и фильтрации колонок с датами и временем view-функцией, отвечающей за получение содержимого csv-файла.<br>
Чтобы выполнить маркировку, отправьте **PUT**-запрос, в **url** замените **{file_name}** на имя файла, а вместо **{datetime_col}** укажите название колонки.<br>
Успешный запрос добавит к названию колонки суффикс **(dt)**.
<br>

* **Получение содержимого csv-файла**
```
http://127.0.0.1:8000/csv_api/files/{filename}/data/?**query_params
```
API предусматривает возможность выгружать данные конкретного файла с опциональными фильтрацией и сортировкой по одному или нескольким столбцам.
Для этого необходимо отправить **GET**-запрос с указанием `{filename}` и параметров фильтрации и сортировки.

**Список параметров и порядок фильтрации:**

*Сортировка*<br>

За сортировку выборки отвечает параметр **order_by**. В качестве значения необходимо передать название(я) столбца(ов) через запятую. При указании перед названием столбца префикса '-', программа отсортирует данные в порядке убывания.<br>
Пример запроса:
```
http://127.0.0.1:8000/csv_api/files/somefile.csv/data/?order_by=col1,-col2(dt)
```
<br>

*Выбор стобца(ов)*<br>

С помощью параметра **columns** возможно выполнить выгрузку данных ограниченного числа стобцов.
Пример запроса:
```
http://127.0.0.1:8000/csv_api/files/somefile.csv/data/?columns=col1,col2(dt),col3
```
<br>

*Фильтрация*<br>

Запрашиваемые данные можно отфильтровать по значениям одного или нескольких столбцов.<br>
Имя параметра фильтрации - название столбца, а значение - строчное выражение, число, дата или время, а также True или False для поиска пустых значений стобца.<br>
При всех видах фильтрации, кроме строковых, к имени фильтра необходимо добавить оператор сравнения 'gt'(больше), 'ge'(больше или равно), 'lt'(меньше), 'le'(меньше или равно), 'eq'(равно), 'ne'(не равно) или 'is_null' для поиска пустых значений.<br>
Оператор добавляется через <ins>двойное подчёркивание</ins>, например:
```
.../data/?col1__gt=100
```
<br>

Колонки, содержащие строчные выражения фильтруются по частичному совпадению со значением фильтра и учётом регистра.<br>
Пример запроса с фильтрацией по строчному выражению:
```
http://127.0.0.1:8000/csv_api/files/somefile.csv/data/?col3=Google
```
<br>

Для корректного отображения результатов фильтрации по дате и времени используйте промежутки с обозначением верхней и нижней временной границы с помощью операторов 'gt'(больше), 'ge'(больше или равно), 'lt'(меньше), 'le'(меньше или равно).
Например, для получение всех записей в промежутке от 2019-01 до 2019-12 отправьте запрос в данном формате:
```
http://127.0.0.1:8000/csv_api/files/somefile.csv/data/?&col2(dt)__gt=2018&col2(dt)__lt=2020
```
<br>

Запросы фильтрации по пустым и непустым значениям выглядят следующим образом:
```
http://127.0.0.1:8000/csv_api/files/somefile.csv/data/?&col3__is_null=True
```
```
http://127.0.0.1:8000/csv_api/files/somefile.csv/data/?&col3__is_null=False
```
<br>
_ _ _

Ниже приведён пример запроса, где **одновременно** применяется **сортировка, выбор столбцов и фильтрация** данных о состоянии занятости и доходов населения Новой Зеландии с сентября 2020 год по декабрь 2022 ([ссылка на скачивание файла](https://drive.google.com/file/d/1WVTC1n8tv9gCCiLkhrfuCVFYG08HNpLz/view?usp=drive_link)):
```
http://127.0.0.1:8000/csv_api/files/business-employment-data-05-2023-quarter-industry-revisions.csv/data/?order_by=-quarter(dt),-filled jobs&columns=quarter(dt),industry_name,filled jobs,total_earnings&quarter(dt)__gt=2022-08&filled jobs__lt=50000
```

Результат запроса:
```
[
    {
        "quarter(dt)": "2022-09-01 00:00:00",
        "industry_name": "Information Media and Telecommunica",
        "filled jobs": 31413,
        "total_earnings": 761
    },
    {
        "quarter(dt)": "2022-09-01 00:00:00",
        "industry_name": "Electricity, Gas, Water and Waste S",
        "filled jobs": 21652,
        "total_earnings": 575
    },
    {
        "quarter(dt)": "2022-09-01 00:00:00",
        "industry_name": "Mining",
        "filled jobs": 5475,
        "total_earnings": 154
    },
    {
        "quarter(dt)": "2022-12-01 00:00:00",
        "industry_name": "Information Media and Telecommunica",
        "filled jobs": 30797,
        "total_earnings": 722
    },
    {
        "quarter(dt)": "2022-12-01 00:00:00",
        "industry_name": "Electricity, Gas, Water and Waste S",
        "filled jobs": 21489,
        "total_earnings": 537
    },
    {
        "quarter(dt)": "2022-12-01 00:00:00",
        "industry_name": "Mining",
        "filled jobs": 5634,
        "total_earnings": 166
    }
]
```
